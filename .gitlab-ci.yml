image: rust:latest
stages:
  - setup
  - test

cache: 
  key: build-cache
  paths: 
    - .cargo/
    - .cache/
    - target/

setup-rustup:
  stage: setup
  script:
    - mkdir -p $CI_PROJECT_DIR
    - rm -rf $CI_PROJECT_DIR/.cargo/cargo
    - mv /usr/local/cargo $CI_PROJECT_DIR/.cargo
    - ln -s $CI_PROJECT_DIR/.cargo/ /usr/local/cargo
    - rustup toolchain update stable
    - rustup toolchain update beta
    - rustup toolchain update nightly
    - sccache -v && export RUSTC_WRAPPER=$CI_PROJECT_DIR/.cargo/bin/sccache; cargo install sccache

.test-template: &test-template
  stage: test
  before_script:
    - mkdir -p $CI_PROJECT_DIR
    - rm -rf $CI_PROJECT_DIR/.cargo/cargo
    - mv /usr/local/cargo $CI_PROJECT_DIR/.cargo
    - ln -s $CI_PROJECT_DIR/.cargo/ /usr/local/cargo
    - sccache -v && export RUSTC_WRAPPER=$CI_PROJECT_DIR/.cargo/bin/sccache
    - export RUST_BACKTRACE=1
    - rustup default "$RUST_TOOLCHAIN"
    - rustup --version
    - rustc --version
    - cargo --version
  script:
    - cargo test --tests --jobs 1
    - cargo test --tests --jobs 1 --release
    - cargo test --features doctest --doc --jobs 1
    - cargo test --features doctest --doc --jobs 1 --release
    - cargo test --no-default-features --tests --jobs 1
    - cargo test --no-default-features --tests --jobs 1 --release

test-stable:
  <<: *test-template
  variables:
    RUST_TOOLCHAIN:  stable

test-beta:
  <<: *test-template
  variables:
    RUST_TOOLCHAIN:  beta

test-nightly:
  <<: *test-template
  variables:
    RUST_TOOLCHAIN:  nightly

test-coverage:
  <<: *test-template
  variables:
    RUST_TOOLCHAIN: stable
  script:
    - cargo install cargo-tarpaulin
    - cargo tarpaulin --verbose

test-fmt:
  <<: *test-template
  variables:
    RUST_TOOLCHAIN: stable
  script:
    - rustup component add rustfmt
    - cargo fmt --all --verbose -- --check

test-clippy:
  <<: *test-template
  variables:
    RUST_TOOLCHAIN: stable
  script:
    - rustup component add clippy
    - cargo clippy -- -D warnings
    - cargo clippy --no-default-features -- -D warnings

test-docs:
  <<: *test-template
  variables:
    RUST_TOOLCHAIN: nightly
  script:
    - cargo doc --no-deps
